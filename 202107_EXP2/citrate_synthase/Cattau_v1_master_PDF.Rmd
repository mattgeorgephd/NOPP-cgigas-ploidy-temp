---
title: "Citrate Synthase (for publication)"
author: "Olivia Cattau"
date: '2023-01-06'
output: md_document
email: ocattau@uw.edu | oliviacattau@gmail.com
---
Coding Resources for paper named X authored by Olivia Cattau, Matt George and Steven Roberts
University of Washington School of Aquatic and Fisheries Sciences
Primary Contact: Olivia Catttau

For Calculating and Analysis of Citrate Synthase Enzyme Activity in Pacific Oysters (C. gigas)

#Load Libraries for the entire script
```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(knitr)
library(lme4)
library(tidyverse)
library(bestNormalize)
library(agricolae)
library(multcompView)
library(survival) 
```

#Load Raw Citrate Synthase Absorbance data and Protein Data from spectrophotometer 
```{r}
CS_absorbance<-read.csv(file="https://raw.githubusercontent.com/ocattau/CS-manuscript/main/raw-data/Rawdata_Absorbance_CS.csv")
BSA_absorbance<-read.csv(file="https://raw.githubusercontent.com/ocattau/CS-manuscript/main/raw-data/BSA_absorbance.csv")
```

#Load morphometric data and labels for oyster numbers
```{r}
morph<-read.csv(file="https://raw.githubusercontent.com/mattgeorgephd/NOPP-gigas-ploidy-temp/main/202107_EXP2/citrate_synthase/Raw%20Data/morphometrics_CS.csv")
```

#Look at Background Control for significance
```{r}
CS_background<-read.csv(file="https://raw.githubusercontent.com/mattgeorgephd/NOPP-gigas-ploidy-temp/main/202107_EXP2/citrate_synthase/Raw%20Data/CS_12_10_22_background.csv") 

CS_BACKGROUND_ANOVA<-lm(CS_background$Absorbance...405..0.1s...A.~bck, data=CS_background)
car::Anova(CS_BACKGROUND_ANOVA)  

background_plot<-ggplot(data=CS_background, aes(x=Repeat, y=CS_background$Absorbance...405..0.1s...A., color=(bck)))+geom_point()+theme_bw()+geom_smooth(method="lm", se=FALSE, formula=y~x)+scale_x_continuous(breaks=seq(1, 10, by=1)   ) 
background_plot
```
background control is significantly different from the standard CS values which means that I do not have to subtract the background from the sample readings. Also you can see in 'background plot' that the background readings did not increase while the CS readings did. 

#Look at plate effects before proceding
```{r}
anova1<-lm(delta.OD~plate*X1*X10*repeat., data=CS_absorbance)
anova(anova1)
summary(anova1) #plate effects not significant
```
no plate effects (p=0.3319), can use entire data set

#View Controls
plot CS standards to calculate standard curve equation
```{r}
CS_controls<-filter(CS_absorbance, ID == 0 | ID == 8 | ID == 16 | ID == 24 | ID == 32 |ID == 40) 

CS_controls2<-(CS_absorbance[c(2:6),]) 

#plot CS standards
standard_plot<-ggplot(data=CS_controls,(aes(x=X1, y=as.numeric(ID))))+geom_point()+geom_smooth(method="lm", se=FALSE, formula = y ~ poly(x, 1) )+xlab("A @ 570nm")+ylab("standard values")+theme_bw()+stat_regline_equation(label.x=0.25, label.y=20)
```

#Extract Equation from standard curve
$y= 33x + 2.2$

#Calculate OD and CS values from standard curve
$OD=X10-X1$
$x=OD$ so that $nmol CS = 33*OD +2.2$
```{r}
control_table<-CS_absorbance %>% 
  group_by(ID) %>% #group by oyster label (for combining replicates)
  summarise(avg1=mean(X1), avg2=mean(X10)) %>% #average OD
  filter(ID != 'R52') #outlier from anova analysis 

CS_absorbance2<-mutate(control_table, OD = avg2-avg1)

CS_absorbance3<-mutate(CS_absorbance2, nmol = 33*OD + 2.2) #nmol of CS enzyme
```

#Calculate protein values from Bovine Serum Assay (BSA) to standardize CS values
```{r}
protein_data<-BSA_absorbance %>%
  group_by(ID) %>%
  summarise(BSA = mean(A))

bsa_standards<-filter(protein_data, ID == 0 | ID == 125 |ID == 250| ID == 500 | ID == 750 | ID == 1000| ID == 1500 | ID == 2000)
plot(bsa_standards) #linear portion only from 0 to 1000

bsa_standards<-(protein_data[c(1, 2, 3, 6, 7, 8),]) #select correct values [0:1000]

bsa_standards$ID <- as.numeric(as.character(factor(bsa_standards$ID, levels=c("0", "125", "250", "500", "750", "1000"))))

BSA_standard_curve<-ggplot(data=bsa_standards,(aes(x=BSA, y=(ID))))+geom_point()+geom_smooth(method="lm", se=FALSE, formula = y ~ x )+theme_bw()+stat_regline_equation(label.x=0.6, label.y=500)+ylab("ug/mL")
```
Equation from BSA protein curve produces $y=2300x-1500$ where y=Protein in ug/mL and x=Absorbance from spectrophotometer from BSA assay

#Make final table with combined CS and BSA values
$nmol CS = 33*OD +2.2$
```{r}
protein_data$protein<-(2300*protein_data$BSA)-1500 #ug/mL

protein_data$P<-(protein_data$protein)/1000/1000 #ug/ml-> ug/uL-> mg/uL  also equal to total protein extracted 

t<-45 #min
m<-33 #slope from CS standard curve
b<-2.2 #intercept from CS standard curve
V<-50 #uL from CS procedure 
D<-1 #dilution coefficient, should be 1 since we did not dilute

Full_dataset<-full_join(CS_absorbance3, protein_data, by='ID')

Full_dataset<-Full_dataset[complete.cases(Full_dataset),] #remove NAs

Full_dataset$CS_activity<-(Full_dataset$nmol/(t*V))*D/Full_dataset$P
```      

#Attach Morphometric Data
Join the results (CS and BSA data) to morphometric data gathered during the experiment,
n=68 
```{r}
treatments<-read.csv("https://raw.githubusercontent.com/mattgeorgephd/NOPP-gigas-ploidy-temp/main/202107_EXP2/citrate_synthase/Raw%20Data/treatments2.csv")

filter_my_data<-morph %>%
  filter(morph$ID %in% Full_dataset$ID)

filter_my_data2<-filter_my_data[c(1,2,5,6,10,11,12,14,16,17)] #remove columns without data
#keep: ploidy, trt, shell_length, shell_width, shell_height, mortality, shell volume, cal_dry_weight, ploidy.trt, tank

Full_data<-full_join(filter_my_data2, treatments, by="ID")

Full_data2<-full_join(Full_data, Full_dataset, by="ID")

Full_data3<-Full_data2[complete.cases(Full_data2),] #remove NAs


#add mortality data
#mortality
mortality<-read.csv("/Users/oliviacattau/Documents/GitHub/NOPP-gigas-ploidy-temp/202107_EXP2/citrate_synthase/Raw Data/survival_oc.csv")
final_mort<-mortality$X..survival
final_list<-mortality$trt
mortality2<-data.frame(final_mort, final_list)
```

#Statisical Analysis
is the data balanced? Does the data need transformation?
```{r}
#is the data balanced
balance<-ggplot(data=Full_data3)+geom_bar(aes(x=trt, color=ploidy))+ylim(0,15)+theme_minimal()
# data is not balanced, used Multilevel models

#does the data need transformation?
test_me<-Full_data3$CS_activity
norm_test <- shapiro.test(test_me) # p-value fail = good, don't need transformation
if(norm_test$p.value<0.05)     {
        normalized <- bestNormalize(test_me)
        test_me <- normalized$x.t # overwrite
        qqnorm(test_me) # check linearity of transformed data
        qqline(test_me)
        print(shapiro.test(test_me))
        print("transformed!",quote=FALSE)}
```
looks good, no need for transformation

#Model Testing for Significance
```{r}
supp1<-read.csv(file="/Users/oliviacattau/Documents/GitHub/CS-manuscript/raw-data/supp1.csv") #heat= 2n-H, 2n-HD, 3n-H, 3n-HD 

ploidy_heat_interactions_model<-aov(nmol~ploidy*heat*desiccation, data=supp1) 
summary(ploidy_heat_interactions_model)
plot(ploidy_heat_interactions_model, 4) #All data with Cook's distance > 0.5 will be removed
#point 59 is an outlier, removed in line 80
#desiccation more important than heat, no interaction between ploidy and heat treatments 

temperature_model<-lm(nmol~stress, data=supp1)
summary(temperature_model)
table2<-do.call(rbind.data.frame, (TukeyHSD(aov(temperature_model))))
#desiccation but not heat is significant

#test for significance across morphometric data
morphometric_model<-aov(nmol~ploidy+shell_volume+shell_height+ shell_length + shell_width, data=supp1)
car::Anova(morphometric_model, type=2)
summary(morphometric_model) #trt=treatments are the only variable that is significant...verify individual HSD results in line 194
plot(morphometric_model, 4) 

dry_weight_model<-aov(nmol~calc_dry_weight,  data=supp1)#dry weight only
summary(dry_weight_model)

ploidyANOVA<-lm(CS_activity~ploidy, data=Full_data3)
car::Anova(ploidyANOVA, type=2)
#CS activity is not significantly different between ploidy groups 

#trt is significant, look at groups
trtANOVA<-lm(CS_activity~trt, data=Full_data3)
car::Anova(trtANOVA, type=3)
table1<-do.call(rbind.data.frame, (TukeyHSD(aov(trtANOVA))))
table1 #significant codes for trt groups

#multi-variant comparison
tx<-with(Full_data3, interaction(trt, ploidy))
amod<-aov(CS_activity ~ tx, data=Full_data3)
mult_comp<-HSD.test(amod, "tx", group=TRUE, console=TRUE)
mult_comp
mortality2$sig_groups<-c("c", "a", "bc", "c", "ab", "c")
mortality2$trt<-c("control", "heat + desiccation", "heat","control", "heat + desiccation", "heat")
mortality2$ploidy<-c("D", "D", "D", "T", "T", "T")

STATS = Full_data3 %>% group_by(trt) %>% 
  summarize(Q75 = quantile(CS_activity, probs = 0.75),
            Q25 = quantile(CS_activity, probs = 0.25),
            MaxVal = max(CS_activity), .groups = "keep") %>% 
  mutate(WhiskUp = 1.05* (Q75 + 1.5 * (Q75 - Q25)))
pans2 = distinct(Full_data3, trt) %>%
  arrange(trt) %>% 
  inner_join(STATS, by = c("trt"))
pans2$label = c("c", "a", "bc", "c", "ab", "c")
```

#Kaplan Meier Survival Analysis 
Ho: In terms of survivability, there is no difference between the two groups.

Hi: There is a survival differential between the groups.

```{r}
kaplan_mort<-read.csv(file="/Users/oliviacattau/Documents/GitHub/CS-manuscript/raw-data/kaplan_meier_km.csv")

fit_trt<-survdiff(Surv(time, status) ~trt, kaplan_mort) #p=2e-05

fit_ploidy<-survdiff(Surv(time, status) ~ploidy, kaplan_mort) #p=0.02

fit_combo<-survdiff(Surv(time, status) ~combo, kaplan_mort) #p= 1e-06 

desiccation_only<- kaplan_mort %>%
  filter(trt==c("MS"))

not_Ms<- kaplan_mort %>%
  filter(trt!=c("MS"))

triploid_only<-kaplan_mort %>%
  filter(trt!=c("control")) %>%
  filter(ploidy==c("T"))
 
fit_desiccation_only<-survdiff(Surv(time, status) ~combo, desiccation_only) #p=0.008

fit_MS<-survdiff(Surv(time, status) ~combo, not_Ms) #p=0.4

fit_triploid_only<-survdiff(Surv(time, status)~combo, triploid_only) #p= 6e-05 

SS_MS<-kaplan_mort%>%
  filter(trt!=c("control"))
  
SS_control<-kaplan_mort%>%
  filter(trt!=c("MS"))
  
MS_control<-kaplan_mort%>%
  filter(trt!=c("SS"))

SS_only<-kaplan_mort%>%
  filter(trt==c("SS"))
  
fit_SS_MS<-survdiff(Surv(time, status) ~combo, SS_MS)#p= 1e-05

fit_SS_control<-survdiff(Surv(time, status) ~combo, SS_control)#p= 0.4 

fit_MS_control<-survdiff(Surv(time, status) ~combo, MS_control)#p= 3e-05 

fit_SS_only<-survdiff(Surv(time, status) ~combo, SS_only) #p=0.8

```

#Data visualization 
```{r}
ploidy_linear_plot<-ggplot(data=Full_data3,(aes(x=protein, y=CS_activity, color=ploidy)))+geom_point()+theme_bw()+geom_smooth(method="lm", se=FALSE, formula = y ~ x ) + ylab("CS Activity (nmol/(mg*min))") +xlab("Protein (ug/mL)")
#ploidy does not determine CS activity

boxplot2<-ggplot(data=Full_data3, aes(x=trt, y=CS_activity, label=ploidy))+
  geom_boxplot(aes(x=factor(trt, level=c('D-control', 'D-heat', 'D-desiccation', 'T-control', 'T-heat', 'T-desiccation')), y=CS_activity, color=ploidy))+
  theme_minimal()+geom_point(data=Full_data3, aes(color=ploidy), alpha=0.5)+
  ylab(expression('CS activity nmol' (min^-1) (mg^-1)))+
  xlab("Treatment Group") + geom_text(data = pans2, aes(y = WhiskUp, label = label ), position = position_dodge(width = .75))+scale_y_continuous(limits=c(0,8))

boxplot2 #with letters for significance 


boxplot3<-ggplot(data=Full_data3, aes(x=factor(trt_short), y=CS_activity))+geom_boxplot(aes(x=factor(trt_short, level=c("control", "heat", "heat + desiccation")), y=CS_activity))+theme_minimal()+geom_point(data=Full_data3, alpha=0.5)+ ylab(expression('CS activity nmol' (min^-1) (mg^-1)))+xlab("Treatment Group") +scale_y_continuous(limits=c(0,8))+facet_wrap(~ploidy2)+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))

boxplot3 #bw plot for publication

boxplot4<-ggplot(data=Full_data3, aes(x=factor(trt_short), y=CS_activity))+geom_boxplot(aes(x=factor(trt_short, level=c("control", "heat", "heat + desiccation")), y=CS_activity, fill=group_short))+theme_minimal()+ theme(legend.position = "none")+geom_point(data=Full_data3, alpha=0.5)+ ylab(expression('CS activity nmol' (min^-1) (mg^-1)))+xlab("Treatment Group") +scale_y_continuous(limits=c(0,8))+facet_wrap(~ploidy2)+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))+scale_fill_manual(values=c("#999999",
                               "orange",
                               "red",
                               "green",
                               "brown"))
boxplot4 #colors for presentation

boxplot5<-ggplot(data=Full_data3, aes(x=factor(trt_short), y=CS_activity))+geom_boxplot(aes(x=factor(trt_short, level=c("control", "heat", "heat + desiccation")), y=CS_activity, fill=ploidy))+theme_minimal()+ theme(legend.position = "none") +geom_point(data=Full_data3, alpha=0.5)+ ylab(expression('CS activity nmol' (min^-1) (mg^-1)))+xlab("Treatment Group") +scale_y_continuous(limits=c(0,8))+facet_wrap(~ploidy2)+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))+scale_fill_manual(values=c("royalblue",
                               "orange",
                               "brown"))


library(stringr)

protein_plot<-ggplot(data=Full_data3,(aes(x=protein, y=nmol, label=ID)))+geom_point()+theme_bw()+geom_smooth(method="lm", se=TRUE, formula = y ~ log(x) ) + ylab("CS Activity nmol") +xlab("Protein (mg/uL)")+geom_text(hjust=1.5, vjust=0)+theme_minimal()+
                   stat_cor(label.y = 1)
protein_plot #no correlation between protein and CS activity 

mort_bar<-ggplot(data=mortality2,aes(ploidy, final_mort, fill=trt))+geom_bar(stat="identity", alpha=0.75, colour="black")+theme_minimal()+ylab("survival")+ xlab("treatments")+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))+scale_fill_manual(values=c("grey",
                               "orange",
                               "red"))

mort_bar2<-ggplot(data=mortality2, aes(final_list, final_mort, fill=trt))+geom_bar(aes(factor(final_list, c("D-control", "D-heat", "D-desiccation", "T-control", "T-heat", "T-desiccation"))), stat="identity", alpha=0.75, colour="black")+theme_minimal()+ylab("survival")+ xlab("treatments")+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 14))+scale_fill_manual(values=c("grey",
                               "orange",
                               "red"))

mort_bar3<-ggplot(data=mortality2,aes(ploidy, final_mort, fill=ploidy))+geom_bar(stat="identity", alpha=0.9, colour="black", aes(factor(trt, c("control", "heat", "heat + desiccation"))))+theme_minimal()+ylab("survival")+ xlab("treatments")+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))+scale_fill_manual(values=c("royalblue",
                               "orange",
                               "red"))

mort_bar4<-ggplot(data=mortality2,aes(ploidy, final_mort, fill=trt))+geom_bar(stat="identity", alpha=0.9, colour="black")+theme_minimal()+ylab("survival")+ xlab("treatments")+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))+scale_fill_manual(values=c("royalblue",
                               "orange",
                               "red"))

mort_bar5<-ggplot(data=mortality2,aes(ploidy, final_mort, fill=ploidy))+geom_bar(stat="identity", alpha=0.9)+theme_minimal()+ylab("survival")+ xlab("treatments")+scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+ theme(text = element_text(size = 15))+scale_fill_manual(values=c("royalblue",
                               "orange",
                               "red"))
```
Based on the HSD (Honestly Significantly Different Test) Triploid desiccation and Diploid desiccation groups are not significantly different from each other but they are significantly different than both control groups as well as Triploid heated group. Only the diploid desiccation treatment was significantly different than all other groups with the Triploid desiccation treatment not being different from the Diploid heated group. 

#Are CS and Respiration (umol/L/hour) positively correlated?
```{r}
respirometry<-read.csv(file="https://raw.githubusercontent.com/mattgeorgephd/NOPP-gigas-ploidy-temp/main/202107_EXP2/respirometry/output/processed_summary_oyster.csv")

trt_master<-read.csv(file="/Users/oliviacattau/Documents/GitHub/NOPP-gigas-ploidy-temp/202107_EXP2/respirometry/output/trt_list.csv")

#group by time
resp_data2<-respirometry %>%
  group_by(trt_list) %>% 
  summarise(avgRES = mean(umol_L_h))

#group by treatment
resp_data<- respirometry %>%
  group_by(group_list) %>%
  summarise(avgRES = mean(umol_L_h))

resp_data1<-Full_data3 %>%
  group_by(trt) %>%
  summarise(avgCS = mean(CS_activity))

respdata<-cbind(resp_data, resp_data1, mortality2)

respdata2<-left_join(resp_data2, trt_master)

resp_plot1<-ggplot(data=respdata, aes(x=avgRES, y=avgCS))+geom_point(aes(color=group_list), size=5)+theme_minimal()+geom_smooth()+stat_regline_equation(label.x=25, label.y=2.0)

trt_levels<-c('D_control_-10', 'T_control_-10', 'D_heat_only_-10', 'T_heat_only_-10', 'D_desiccation_-10', 'T_desiccation_-10','D_control_1', 'T_control_1', 'D_heat_only_1', 'T_heat_only_1', 'D_desiccation_1', 'T_desiccation_1', 'D_control_2', 'T_control_2', 'D_heat_only_2', 'T_heat_only_2', 'D_desiccation_2', 'T_desiccation_2','D_control_6', 'T_control_6', 'D_heat_only_6', 'T_heat_only_6', 'D_desiccation_6', 'T_desiccation_6', 'D_control_10', 'T_control_10', 'D_heat_only_10', 'T_heat_only_10', 'D_desiccation_10', 'T_desiccation_10')

resp_plot2<-ggplot(respdata2, aes(x=time, y=avgRES, colour=group_list))+geom_point()+theme_minimal()+geom_line()

resp_plot3<-ggplot(respdata2, aes(x=factor(trt_list, level=trt_levels), y=avgRES, colour=trt))+geom_smooth()+geom_point(size=3)+theme_minimal()

resp_ploidy<-ggplot(respdata2, aes(x=number, y=avgRES, color=ploidy)) +geom_point() +geom_smooth()+stat_regline_equation(label.x=7, label.y=50)
```
As a whole, respirometry is not positively correlated with CS. But if you removed the Triploid heat only group it is positively correlated. 
